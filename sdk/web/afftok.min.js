/**
 * AffTok Web SDK v1.0.0 - Minified
 * https://afftok.com
 * MIT License
 */
!function(e){"use strict";const t={DEFAULT_BASE_URL:"https://api.afftok.com",CLICK_ENDPOINT:"/api/sdk/click",CONVERSION_ENDPOINT:"/api/sdk/conversion",FALLBACK_CLICK_ENDPOINT:"/api/c",FALLBACK_CONVERSION_ENDPOINT:"/api/convert",MAX_QUEUE_SIZE:1e3,MAX_RETRY_ATTEMPTS:5,INITIAL_RETRY_DELAY_MS:1e3,MAX_RETRY_DELAY_MS:3e5,FLUSH_INTERVAL_MS:3e4,MAX_REQUESTS_PER_MINUTE:60,CONNECTION_TIMEOUT_MS:1e4,QUEUE_KEY:"afftok_offline_queue",DEVICE_ID_KEY:"afftok_device_id",SDK_VERSION:"1.0.0",SDK_PLATFORM:"web"};function n(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}async function i(e){const t=(new TextEncoder).encode(e),n=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(n)).map(e=>e.toString(16).padStart(2,"0")).join("")}async function s(e,t){const n=new TextEncoder,i=n.encode(e),s=n.encode(t),o=await crypto.subtle.importKey("raw",i,{name:"HMAC",hash:"SHA-256"},!1,["sign"]),a=await crypto.subtle.sign("HMAC",o,s);return Array.from(new Uint8Array(a)).map(e=>e.toString(16).padStart(2,"0")).join("")}class o{constructor(){this.isInitialized=!1,this.options=null,this.queue=[],this.flushInterval=null,this.isProcessing=!1,this.deviceId=null,this.fingerprint=null}async init(e){this.isInitialized||(this.options={baseUrl:t.DEFAULT_BASE_URL,debug:!1,autoFlush:!0,autoTrack:!1,flushInterval:t.FLUSH_INTERVAL_MS,...e},this._loadQueue(),await this._initDeviceInfo(),this.options.autoFlush&&this._startAutoFlush(),this.options.autoTrack&&this._setupAutoTrack(),window.addEventListener("online",()=>this.flush()),window.addEventListener("beforeunload",()=>this._saveQueue()),this.isInitialized=!0,this._log("SDK initialized successfully"),this._log(`Device ID: ${this.deviceId}`),this._log(`Pending queue items: ${this.queue.length}`))}async trackClick(e){this._ensureInitialized();const n=await this._buildClickPayload(e);try{const i=await this._sendRequest(t.CLICK_ENDPOINT,n);return i.success?(this._log(`Click tracked successfully: ${e.offerId}`),i):(this._enqueue("click",n),this._log(`Click queued for retry: ${e.offerId}`),i)}catch(t){return this._enqueue("click",n),this._log(`Click queued (offline): ${e.offerId}, error: ${t.message}`),{success:!1,message:"Click queued for offline retry",error:t.message}}}async trackSignedClick(e,n){this._ensureInitialized();const i=await this._buildClickPayload(n);i.signed_link=e,i.link_validated=!0;try{const e=await this._sendRequest(t.CLICK_ENDPOINT,i);return e.success||this._enqueue("click",i),e}catch(e){return this._enqueue("click",i),{success:!1,message:"Signed click queued for retry",error:e.message}}}async trackConversion(e){this._ensureInitialized();const n=await this._buildConversionPayload(e);try{const i=await this._sendRequest(t.CONVERSION_ENDPOINT,n);return i.success?(this._log(`Conversion tracked successfully: ${e.transactionId}`),i):(this._enqueue("conversion",n),this._log(`Conversion queued for retry: ${e.transactionId}`),i)}catch(t){return this._enqueue("conversion",n),this._log(`Conversion queued (offline): ${e.transactionId}, error: ${t.message}`),{success:!1,message:"Conversion queued for offline retry",error:t.message}}}async trackConversionWithMeta(e,n){this._ensureInitialized();const i=await this._buildConversionPayload(e);i.metadata=n;try{const e=await this._sendRequest(t.CONVERSION_ENDPOINT,i);return e.success||this._enqueue("conversion",i),e}catch(e){return this._enqueue("conversion",i),{success:!1,message:"Conversion with metadata queued for retry",error:e.message}}}autotrack(){this._ensureInitialized(),this._setupAutoTrack()}enqueue(e,t){return this._ensureInitialized(),this._enqueue(e,t)}async flush(){this._ensureInitialized(),await this._flush()}getFingerprint(){return this._ensureInitialized(),this.fingerprint||""}getDeviceId(){return this._ensureInitialized(),this.deviceId||""}getDeviceInfo(){return this._ensureInitialized(),this._getDeviceInfo()}getPendingCount(){return this.queue.length}isReady(){return this.isInitialized}getVersion(){return t.SDK_VERSION}clearQueue(){this.queue=[],this._saveQueue()}shutdown(){this.flushInterval&&(clearInterval(this.flushInterval),this.flushInterval=null),this._saveQueue(),this.isInitialized=!1,this._log("SDK shutdown")}_ensureInitialized(){if(!this.isInitialized)throw new Error("AffTok SDK not initialized. Call Afftok.init() first.")}async _initDeviceInfo(){this.deviceId=localStorage.getItem(t.DEVICE_ID_KEY),this.deviceId||(this.deviceId=n(),localStorage.setItem(t.DEVICE_ID_KEY,this.deviceId)),this.fingerprint=await this._generateFingerprint()}async _generateFingerprint(){return await i([this.deviceId,navigator.userAgent,navigator.language,screen.width+"x"+screen.height,screen.colorDepth,(new Date).getTimezoneOffset(),navigator.hardwareConcurrency||"unknown",navigator.platform||"unknown"].join("|"))}_getDeviceInfo(){return{device_id:this.deviceId,fingerprint:this.fingerprint,platform:t.SDK_PLATFORM,sdk_version:t.SDK_VERSION,user_agent:navigator.userAgent,language:navigator.language,screen:`${screen.width}x${screen.height}`,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,referrer:document.referrer,url:window.location.href}}async _buildClickPayload(e){const t=Date.now(),n=this._generateNonce(),i={api_key:this.options.apiKey,advertiser_id:this.options.advertiserId,offer_id:e.offerId,timestamp:t,nonce:n,device_info:this._getDeviceInfo()};return this.options.userId&&(i.user_id=this.options.userId),e.trackingCode&&(i.tracking_code=e.trackingCode),e.subId1&&(i.sub_id_1=e.subId1),e.subId2&&(i.sub_id_2=e.subId2),e.subId3&&(i.sub_id_3=e.subId3),e.customParams&&(i.custom_params=e.customParams),i.signature=await this._generateSignature(t,n),i}async _buildConversionPayload(e){const t=Date.now(),n=this._generateNonce(),i={api_key:this.options.apiKey,advertiser_id:this.options.advertiserId,offer_id:e.offerId,transaction_id:e.transactionId,status:e.status||"pending",currency:e.currency||"USD",timestamp:t,nonce:n,device_info:this._getDeviceInfo()};return this.options.userId&&(i.user_id=this.options.userId),e.clickId&&(i.click_id=e.clickId),void 0!==e.amount&&(i.amount=e.amount),e.customParams&&(i.custom_params=e.customParams),i.signature=await this._generateSignature(t,n),i}async _sendRequest(e,n){const i=`${this.options.baseUrl}${e}`,s=new AbortController,o=setTimeout(()=>s.abort(),t.CONNECTION_TIMEOUT_MS);try{const a=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":this.options.apiKey,"X-SDK-Version":t.SDK_VERSION,"X-SDK-Platform":t.SDK_PLATFORM},body:JSON.stringify(n),signal:s.signal});if(clearTimeout(o),a.ok){const e=await a.json();return{success:!0,...e}}return e===t.CLICK_ENDPOINT?this._sendFallbackRequest(t.FALLBACK_CLICK_ENDPOINT,n):e===t.CONVERSION_ENDPOINT?this._sendFallbackRequest(t.FALLBACK_CONVERSION_ENDPOINT,n):{success:!1,error:`HTTP ${a.status}`}}catch(e){throw clearTimeout(o),e}}async _sendFallbackRequest(e,t){try{const n=`${this.options.baseUrl}${e}`,i=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":this.options.apiKey},body:JSON.stringify(t)});return i.ok?{success:!0,message:"Tracked via fallback"}:{success:!1,error:`Fallback failed: ${i.status}`}}catch(e){return{success:!1,error:`Fallback error: ${e.message}`}}}async _generateSignature(e,t){return await s(this.options.apiKey,`${this.options.apiKey}|${this.options.advertiserId}|${e}|${t}`)}_generateNonce(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let t="";for(let n=0;n<32;n++)t+=e.charAt(Math.floor(Math.random()*e.length));return t}_enqueue(e,i){const s=n(),o={id:s,type:e,payload:i,timestamp:Date.now(),retryCount:0,nextRetryTime:0};return this.queue.length>=t.MAX_QUEUE_SIZE&&(this.queue.shift(),this._log("Queue full, removed oldest item")),this.queue.push(o),this._saveQueue(),this._log(`Enqueued ${e} event: ${s}`),s}_startAutoFlush(){this.flushInterval&&clearInterval(this.flushInterval),this.flushInterval=setInterval(()=>this._flush(),this.options.flushInterval),this._log(`Auto-flush started with interval: ${this.options.flushInterval}ms`)}async _flush(){if(this.isProcessing)return void this._log("Flush already in progress, skipping");if(!navigator.onLine)return void this._log("Offline, skipping flush");this.isProcessing=!0,this._log(`Starting flush, ${this.queue.length} items in queue`);const e=Date.now();for(const n of this.queue.filter(t=>t.nextRetryTime<=e))try{(await this._processQueueItem(n))?(this.queue=this.queue.filter(e=>e.id!==n.id),this._log(`Completed: ${n.id}`)):this._markForRetry(n)}catch(e){this._log(`Error processing item ${n.id}: ${e.message}`),this._markForRetry(n)}this._saveQueue(),this.isProcessing=!1,this._log(`Flush completed, ${this.queue.length} items remaining`)}async _processQueueItem(e){try{let n;return"click"===e.type?n=await this._sendRequest(t.CLICK_ENDPOINT,e.payload):"conversion"===e.type&&(n=await this._sendRequest(t.CONVERSION_ENDPOINT,e.payload)),n.success}catch(e){return!1}}_markForRetry(e){if(e.retryCount>=t.MAX_RETRY_ATTEMPTS)return this.queue=this.queue.filter(t=>t.id!==e.id),void this._log(`Max retries reached, removing: ${e.id}`);const n=Math.min(t.INITIAL_RETRY_DELAY_MS*Math.pow(2,e.retryCount),t.MAX_RETRY_DELAY_MS),i=Math.random()*n*.1;e.retryCount++,e.nextRetryTime=Date.now()+n+i,this._log(`Marked for retry (${e.retryCount}/${t.MAX_RETRY_ATTEMPTS}): ${e.id}`)}_loadQueue(){try{const e=localStorage.getItem(t.QUEUE_KEY);e&&(this.queue=JSON.parse(e),this._log(`Loaded ${this.queue.length} items from storage`))}catch(e){this._log(`Error loading queue: ${e.message}`)}}_saveQueue(){try{localStorage.setItem(t.QUEUE_KEY,JSON.stringify(this.queue))}catch(e){this._log(`Error saving queue: ${e.message}`)}}_setupAutoTrack(){document.addEventListener("click",e=>{const t=e.target.closest("a[data-afftok-offer]");if(t){const e=t.getAttribute("data-afftok-offer"),n=t.getAttribute("data-afftok-code"),i=t.getAttribute("data-afftok-sub1"),s=t.getAttribute("data-afftok-sub2"),o=t.getAttribute("data-afftok-sub3");this.trackClick({offerId:e,trackingCode:n,subId1:i,subId2:s,subId3:o})}}),this._log("Auto-track enabled for [data-afftok-offer] links")}_log(e){this.options?.debug&&console.log(`[AffTok SDK] ${e}`)}}const a=new o;e.Afftok=a,"function"==typeof define&&define.amd&&define([],function(){return a}),"object"==typeof module&&module.exports&&(module.exports=a)}("undefined"!=typeof window?window:this);

