# Tracking Flow

This document describes the complete lifecycle of tracking events in AffTok, from initial click to final conversion.

## Click → Conversion Lifecycle

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                        Complete Tracking Lifecycle                           │
└──────────────────────────────────────────────────────────────────────────────┘

  ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
  │  Click  │────▶│  Visit  │────▶│ Action  │────▶│Postback │────▶│Conversion│
  │  Event  │     │  Page   │     │ (Buy)   │     │  Sent   │     │ Recorded │
  └─────────┘     └─────────┘     └─────────┘     └─────────┘     └─────────┘
       │               │               │               │               │
       ▼               ▼               ▼               ▼               ▼
  ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
  │ Click   │     │ Landing │     │ Checkout│     │ Server  │     │  Stats  │
  │ Tracked │     │  Page   │     │  Flow   │     │  Call   │     │ Updated │
  └─────────┘     └─────────┘     └─────────┘     └─────────┘     └─────────┘
```

## Phase 1: Click Tracking

### Step 1.1: User Clicks Tracking Link

A user clicks a tracking link generated by AffTok:

```
https://track.afftok.com/c/abc123.1699876543210.nonce123.signature456
                          │      │              │         │
                          │      │              │         └── HMAC Signature
                          │      │              └── Random Nonce
                          │      └── Timestamp (ms)
                          └── Tracking Code
```

### Step 1.2: Edge Layer Processing

The edge layer (CDN) processes the request in < 20ms:

```
┌─────────────────────────────────────────────────────────────┐
│                    Edge Processing                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. Parse signed link components                            │
│     ├── tracking_code: abc123                               │
│     ├── timestamp: 1699876543210                            │
│     ├── nonce: nonce123                                     │
│     └── signature: signature456                             │
│                                                             │
│  2. Validate signature (HMAC-SHA256)                        │
│     signature = HMAC(secret, "abc123.1699876543210.nonce123")│
│                                                             │
│  3. Check TTL (5 minutes default)                           │
│     if (now - timestamp > 300000) → EXPIRED                 │
│                                                             │
│  4. Check replay (nonce in Redis)                           │
│     if (nonce exists) → REPLAY_ATTEMPT                      │
│                                                             │
│  5. Validate geo rules                                      │
│     country = CF-IPCountry header                           │
│     if (country blocked) → GEO_BLOCKED                      │
│                                                             │
│  6. Detect bots                                             │
│     if (bot detected) → BOT_BLOCKED                         │
│                                                             │
│  7. Store nonce (TTL: 5 min)                                │
│                                                             │
│  8. Queue click event (async)                               │
│                                                             │
│  9. Redirect to destination URL                             │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Step 1.3: Click Event Structure

```json
{
  "click_id": "clk_abc123def456",
  "user_offer_id": "uo_xyz789",
  "offer_id": "off_123",
  "user_id": "usr_456",
  "tracking_code": "abc123",
  "timestamp": 1699876543210,
  "ip_address": "203.0.113.45",
  "user_agent": "Mozilla/5.0 (iPhone; CPU iPhone OS 17_0...",
  "device": "mobile",
  "browser": "Safari",
  "os": "iOS",
  "country": "US",
  "city": "New York",
  "fingerprint": "fp_a1b2c3d4e5f6",
  "referrer": "https://example.com/page",
  "sub_ids": {
    "sub1": "facebook",
    "sub2": "campaign_123",
    "sub3": "creative_456"
  }
}
```

### Step 1.4: Backend Processing

```
┌─────────────────────────────────────────────────────────────┐
│                  Backend Click Processing                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. Receive click event from edge queue                     │
│                                                             │
│  2. Deduplication check                                     │
│     key = "click:dedup:{fingerprint}:{offer_id}"            │
│     if (exists in Redis) → skip                             │
│                                                             │
│  3. Resolve tracking code                                   │
│     user_offer = db.find(tracking_code)                     │
│                                                             │
│  4. Begin transaction                                       │
│     ├── INSERT click record                                 │
│     ├── INCREMENT user_offer.total_clicks                   │
│     ├── INCREMENT offer.total_clicks                        │
│     ├── INCREMENT user.total_clicks                         │
│     └── INCREMENT user.monthly_clicks                       │
│                                                             │
│  5. Update Redis counters                                   │
│     ├── INCR tenant:{id}:clicks:total                       │
│     ├── INCR tenant:{id}:clicks:daily:{date}                │
│     └── INCR offer:{id}:clicks:total                        │
│                                                             │
│  6. Store dedup key (TTL: 60s)                              │
│                                                             │
│  7. Log click event                                         │
│                                                             │
│  8. Commit transaction                                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## Phase 2: User Journey

After the click is tracked, the user lands on the destination:

```
┌─────────────────────────────────────────────────────────────┐
│                     User Journey                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Tracking Link                                              │
│       │                                                     │
│       ▼                                                     │
│  ┌─────────────┐                                            │
│  │   AffTok    │  ← Click recorded                          │
│  │   Redirect  │                                            │
│  └──────┬──────┘                                            │
│         │                                                   │
│         ▼                                                   │
│  ┌─────────────┐                                            │
│  │   Landing   │  ← User browses                            │
│  │    Page     │                                            │
│  └──────┬──────┘                                            │
│         │                                                   │
│         ▼                                                   │
│  ┌─────────────┐                                            │
│  │   Product   │  ← User explores                           │
│  │    Page     │                                            │
│  └──────┬──────┘                                            │
│         │                                                   │
│         ▼                                                   │
│  ┌─────────────┐                                            │
│  │   Checkout  │  ← User converts                           │
│  │    Flow     │                                            │
│  └──────┬──────┘                                            │
│         │                                                   │
│         ▼                                                   │
│  ┌─────────────┐                                            │
│  │   Thank     │  ← Conversion pixel fires                  │
│  │   You Page  │                                            │
│  └─────────────┘                                            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## Phase 3: Conversion Tracking

### Step 3.1: Postback Request

When a conversion occurs, the advertiser sends a postback:

```http
POST /api/postback HTTP/1.1
Host: api.afftok.com
Content-Type: application/json
X-API-Key: afftok_live_sk_xxxxxxxxxxxxx

{
  "api_key": "afftok_live_sk_xxxxxxxxxxxxx",
  "advertiser_id": "adv_123456",
  "offer_id": "off_123",
  "transaction_id": "txn_abc123def456",
  "click_id": "clk_abc123def456",
  "amount": 49.99,
  "currency": "USD",
  "status": "approved",
  "timestamp": 1699876600000,
  "nonce": "random32characterstring12345678",
  "signature": "hmac_sha256_signature_here"
}
```

### Step 3.2: Postback Processing

```
┌─────────────────────────────────────────────────────────────┐
│                  Postback Processing                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. Authenticate request                                    │
│     ├── Validate API key                                    │
│     ├── Check key status (active)                           │
│     └── Verify HMAC signature                               │
│                                                             │
│  2. Validate request                                        │
│     ├── Check required fields                               │
│     ├── Validate timestamp (< 5 min old)                    │
│     └── Check nonce (replay protection)                     │
│                                                             │
│  3. Deduplication                                           │
│     if (transaction_id exists) → DUPLICATE                  │
│                                                             │
│  4. Find associated click                                   │
│     click = db.find(click_id)                               │
│     if (!click) → CLICK_NOT_FOUND                           │
│                                                             │
│  5. Geo validation (if enabled)                             │
│     if (country blocked) → GEO_BLOCKED                      │
│                                                             │
│  6. Begin transaction                                       │
│     ├── INSERT conversion record                            │
│     ├── INCREMENT user_offer.total_conversions              │
│     ├── INCREMENT user_offer.earnings                       │
│     ├── INCREMENT offer.total_conversions                   │
│     ├── INCREMENT user.total_conversions                    │
│     └── INCREMENT user.total_earnings                       │
│                                                             │
│  7. Log postback                                            │
│                                                             │
│  8. Trigger webhooks                                        │
│                                                             │
│  9. Commit transaction                                      │
│                                                             │
│  10. Return success                                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Step 3.3: Conversion Record

```json
{
  "conversion_id": "conv_xyz789abc123",
  "click_id": "clk_abc123def456",
  "user_offer_id": "uo_xyz789",
  "offer_id": "off_123",
  "user_id": "usr_456",
  "transaction_id": "txn_abc123def456",
  "external_conversion_id": "ext_789",
  "amount": 49.99,
  "currency": "USD",
  "payout": 5.00,
  "status": "approved",
  "network_id": "net_123",
  "network_name": "Example Network",
  "ip_address": "203.0.113.45",
  "country": "US",
  "converted_at": "2024-01-15T10:30:00Z",
  "postback_data": {
    "product_id": "prod_456",
    "category": "electronics"
  }
}
```

## Phase 4: Stats Update

After conversion is recorded, statistics are updated atomically:

```
┌─────────────────────────────────────────────────────────────┐
│                    Stats Update Flow                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Database Updates (Atomic Transaction):                     │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  user_offers SET                                     │   │
│  │    total_clicks = total_clicks + 1                   │   │
│  │    total_conversions = total_conversions + 1         │   │
│  │    earnings = earnings + payout                      │   │
│  │    updated_at = NOW()                                │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  Redis Updates (Async):                                     │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  INCR tenant:{id}:conversions:total                  │   │
│  │  INCR tenant:{id}:conversions:daily:{date}           │   │
│  │  INCR tenant:{id}:earnings:total                     │   │
│  │  INCR offer:{id}:conversions:total                   │   │
│  │  INCR user:{id}:conversions:total                    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  Cache Invalidation:                                        │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  DEL stats:user:{id}                                 │   │
│  │  DEL stats:offer:{id}                                │   │
│  │  DEL stats:tenant:{id}                               │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## Phase 5: Webhook Delivery

If webhooks are configured, they are triggered after conversion:

```
┌─────────────────────────────────────────────────────────────┐
│                   Webhook Delivery                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. Find matching webhook pipelines                         │
│     pipelines = db.find(trigger = "conversion")             │
│                                                             │
│  2. For each pipeline:                                      │
│     ├── Render payload template                             │
│     ├── Sign payload (HMAC or JWT)                          │
│     ├── Queue webhook task                                  │
│     └── Execute steps in order                              │
│                                                             │
│  3. Delivery with retry:                                    │
│     ┌─────────────────────────────────────────────┐        │
│     │  Attempt 1: Immediate                        │        │
│     │  Attempt 2: 5 seconds                        │        │
│     │  Attempt 3: 10 seconds                       │        │
│     │  Attempt 4: 30 seconds                       │        │
│     │  Attempt 5: 1 minute                         │        │
│     │  Attempt 6: 5 minutes                        │        │
│     │  → Failover URL (if configured)              │        │
│     │  → Dead Letter Queue (if still failing)      │        │
│     └─────────────────────────────────────────────┘        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## Timing Summary

| Phase | Typical Duration |
|-------|------------------|
| Edge validation | < 5ms |
| Redirect | < 20ms total |
| Click processing | < 50ms |
| User journey | Minutes to days |
| Postback processing | < 100ms |
| Stats update | < 10ms |
| Webhook delivery | < 500ms (first attempt) |

## Error Handling

At each phase, errors are handled gracefully:

| Phase | Error | Handling |
|-------|-------|----------|
| Click | Invalid signature | Log fraud, redirect anyway |
| Click | Expired link | Log, redirect anyway |
| Click | Geo blocked | Log, redirect to fallback |
| Click | Bot detected | Log, skip tracking |
| Postback | Invalid signature | Return 403 |
| Postback | Duplicate | Return 409 |
| Postback | Click not found | Return 404 |
| Webhook | Delivery failed | Retry with backoff |

## Next Steps

- [Smart Routing](smart-routing.md) - Learn about traffic routing
- [API Reference](../api-reference/clicks.md) - Click API documentation
- [Postback Guide](../api-reference/postbacks.md) - Postback integration

