# Vertical Pod Autoscaler for AffTok Backend
# Automatically adjusts CPU and memory requests/limits
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: afftok-backend-vpa
  namespace: afftok
  labels:
    app: afftok-backend
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: afftok-backend
  
  updatePolicy:
    updateMode: "Auto"  # Auto, Recreate, Initial, Off
    minReplicas: 2  # Keep at least 2 replicas during updates
  
  resourcePolicy:
    containerPolicies:
      - containerName: afftok-backend
        minAllowed:
          cpu: "250m"
          memory: "256Mi"
        maxAllowed:
          cpu: "4000m"
          memory: "8Gi"
        controlledResources: ["cpu", "memory"]
        controlledValues: RequestsAndLimits

---
# VPA for Redis
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: afftok-redis-vpa
  namespace: afftok
  labels:
    app: afftok-redis
spec:
  targetRef:
    apiVersion: apps/v1
    kind: StatefulSet
    name: afftok-redis
  
  updatePolicy:
    updateMode: "Auto"
    minReplicas: 2
  
  resourcePolicy:
    containerPolicies:
      - containerName: redis
        minAllowed:
          cpu: "100m"
          memory: "128Mi"
        maxAllowed:
          cpu: "2000m"
          memory: "16Gi"
        controlledResources: ["cpu", "memory"]

---
# VPA for PostgreSQL
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: afftok-postgres-vpa
  namespace: afftok
  labels:
    app: afftok-postgres
spec:
  targetRef:
    apiVersion: apps/v1
    kind: StatefulSet
    name: afftok-postgres
  
  updatePolicy:
    updateMode: "Off"  # Manual for database - too risky for auto
  
  resourcePolicy:
    containerPolicies:
      - containerName: postgres
        minAllowed:
          cpu: "500m"
          memory: "1Gi"
        maxAllowed:
          cpu: "8000m"
          memory: "32Gi"

---
# VPA Recommender Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: vpa-recommender-config
  namespace: kube-system
data:
  config.yaml: |
    recommenderInterval: 1m
    checkpointsGCInterval: 10m
    prometheusAddress: http://prometheus.monitoring:9090
    storage: prometheus
    
    # Custom resource recommendations
    podResourceRecommendation:
      # Target percentile for resource recommendations
      targetCPUPercentile: 0.9
      targetMemoryPercentile: 0.9
      
      # Safety margins
      safetyMarginFraction: 0.15
      
      # History window
      historyLength: 8d
      
      # Minimum change threshold
      minChangeThreshold: 0.1

